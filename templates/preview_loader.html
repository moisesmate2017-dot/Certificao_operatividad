<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Previsualización - Editar datos</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .invalid { border-color: #dc3545 !important; box-shadow: 0 0 0 .15rem rgba(220,53,69,.25); }
    .table thead th { vertical-align: middle; }
  </style>
</head>
<body class="bg-light">
<div class="container py-4">
  <div class="card shadow-sm">
    <div class="card-body">
      <h4 class="card-title mb-3">Previsualización — Edite los datos antes de generar el PDF</h4>

      <form id="preview-form" method="POST" action="{{ url_for('generar_pdf') }}">
        <!-- Hidden fields requeridos por app.py -->
        <input type="hidden" name="ubicacion" value="{{ ubicacion }}">
        <input type="hidden" name="fecha_inspeccion" value="{{ fecha_inspeccion }}">
        <input type="hidden" name="fecha_emision" value="{{ fecha_emision }}">
        <input type="hidden" name="ingeniero" value="{{ ingeniero }}">

        <div class="mb-3">
          <label class="form-label">Cliente</label>
          <input class="form-control" type="text" name="cliente" id="cliente" value="{{ cliente }}" required>
        </div>

        <div class="mb-3">
          <label class="form-label">Dirección</label>
          <input class="form-control" type="text" name="direccion" id="direccion" value="{{ direccion }}" required>
        </div>

        <hr>
        <h5>Tanques (editar / eliminar / agregar)</h5>
        <div class="table-responsive">
          <table class="table table-sm" id="tanques-table">
            <thead>
              <tr>
                <th>Tipo</th>
                <th>Capacidad (gal)</th>
                <th>Serie</th>
                <th style="width:120px;">Acción</th>
              </tr>
            </thead>
            <tbody>
              {% if tanques %}
                {% for t in tanques %}
                <tr>
                  <td><input class="form-control form-control-sm" name="tipo[]" value="{{ t.tipo }}"></td>
                  <td><input class="form-control form-control-sm capacidad" name="capacidad[]" value="{{ t.capacidad }}"></td>
                  <td><input class="form-control form-control-sm serie" name="serie[]" value="{{ t.serie }}"></td>
                  <td class="text-center"><button type="button" class="btn btn-sm btn-outline-danger remove-row-btn">Eliminar</button></td>
                </tr>
                {% endfor %}
              {% else %}
                <tr>
                  <td><input class="form-control form-control-sm" name="tipo[]" value=""></td>
                  <td><input class="form-control form-control-sm capacidad" name="capacidad[]" value=""></td>
                  <td><input class="form-control form-control-sm serie" name="serie[]" value=""></td>
                  <td class="text-center"><button type="button" class="btn btn-sm btn-outline-danger remove-row-btn">Eliminar</button></td>
                </tr>
              {% endif %}
            </tbody>
          </table>
        </div>

        <div class="mb-3 d-flex gap-2">
          <button type="button" id="add-row" class="btn btn-sm btn-secondary">Agregar tanque</button>

          <label class="form-check form-check-inline align-items-center mb-0 ms-3">
            <input class="form-check-input" type="checkbox" id="guardar_en_base" name="guardar_en_base">
            <span class="form-check-label">Guardar cambios en la base (crea <code>data_base_updated_*.xlsx</code>)</span>
          </label>
        </div>

        <div class="d-flex gap-2">
          <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">Volver</a>
          <button id="confirm-btn" type="submit" class="btn btn-primary">Confirmar y generar PDF</button>
        </div>

        <hr>
        <small class="text-muted">Fecha de emisión calculada: {{ fecha_emision }}</small>
      </form>
    </div>
  </div>
</div>

<script>
  // Eliminar fila
  document.addEventListener('click', function(e){
    if(e.target && e.target.classList.contains('remove-row-btn')){
      const tr = e.target.closest('tr');
      tr.remove();
    }
  });

  // Agregar fila
  document.getElementById('add-row').addEventListener('click', function(){
    const tbody = document.querySelector('#tanques-table tbody');
    const row = document.createElement('tr');
    row.innerHTML = `
      <td><input class="form-control form-control-sm" name="tipo[]" value=""></td>
      <td><input class="form-control form-control-sm capacidad" name="capacidad[]" value=""></td>
      <td><input class="form-control form-control-sm serie" name="serie[]" value=""></td>
      <td class="text-center"><button type="button" class="btn btn-sm btn-outline-danger remove-row-btn">Eliminar</button></td>
    `;
    tbody.appendChild(row);
  });

  // Validación previa al submit
  document.getElementById('preview-form').addEventListener('submit', function(e){
    let valid = true;
    // quitar marcas previas
    document.querySelectorAll('.capacidad, .serie').forEach(function(el){
      el.classList.remove('invalid');
    });

    // capacidad debe ser numérica si no está vacía
    document.querySelectorAll('.capacidad').forEach(function(el){
      const v = el.value.trim();
      if(v !== "" && isNaN(Number(v))){
        valid = false;
        el.classList.add('invalid');
      }
    });

    // si hay tipo o capacidad, serie no puede quedar vacío
    const rows = document.querySelectorAll('#tanques-table tbody tr');
    rows.forEach(function(row){
      const tipo = row.querySelector('input[name="tipo[]"]').value.trim();
      const cap = row.querySelector('input[name="capacidad[]"]').value.trim();
      const serie = row.querySelector('input[name="serie[]"]').value.trim();
      if((tipo !== "" || cap !== "") && serie === ""){
        valid = false;
        row.querySelector('.serie').classList.add('invalid');
      }
    });

    if(!valid){
      e.preventDefault();
      alert("Revise los campos: capacidad debe ser numérica y las filas con tipo/capacidad requieren un número de serie.");
      return false;
    }
    return true;
  });
</script>
</body>
</html>
